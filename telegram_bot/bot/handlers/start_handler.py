from pathlib import Path
from aiogram import types, Router
from aiogram.filters import Command
from keyboards.inline import start_keyboard
from data.main_database import MainDatabase 
from data.users_list_data import UsersDatabase 
from config import bot

# –ü–µ—Ä–µ–¥–∞–µ–º –∫–ª–∞—Å—Å—É, –æ—Ç–≤–µ—á–∞—é—â–µ–º—É –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—É—Ç—å –∫ –Ω–µ–π
current_dir = Path(__file__).parent
db_file_path = current_dir.parent / "utils" / "broadcast" / "database_tg_bot.db"
users_db = UsersDatabase(db_file_path)

data = MainDatabase()
start_router = Router()

@start_router.message(Command('start'))
async def start(message: types.Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.
    –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞:
        - –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ.
        - –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–∞ –∏–∑ —Å—Å—ã–ª–∫–∏.
        - –ï—Å–ª–∏ ID —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º –∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
            - –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—å–∏–º-—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º. –ï—Å–ª–∏ –¥–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ.
            - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á—å–∏–º-—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º:
                - –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–∞, –Ω–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—É.
                - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
                - –û–ø–æ–≤–µ—â–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–∞ –æ –Ω–æ–≤–æ–º —Ä–µ—Ñ–µ—Ä–∞–ª–µ.
        - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª –ø–æ —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ.
        - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª –Ω–µ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    if message.chat.type == 'private':
        if not users_db.user_exists(message.from_user.id):
            users_db.add_user(message.from_user.id)

        start_command = message.text
        referent_id = start_command[7:] # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–∞ –∏–∑ —Å—Å—ã–ª–∫–∏

        if referent_id.isdigit(): # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º
            if referent_id != str(message.from_user.id): # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª –Ω–µ –ø–æ —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–µ
                if await data.is_user_referal(message.from_user.id): # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è —á—å–∏–º-—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º
                    await message.answer("You are already a referral! Don't try to log in through someone's referral link.")
                else: # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á—å–∏–º-—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º
                    # –î–æ–±–∞–≤–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞, –Ω–∞—á–∏—Å–ª–∏–º –Ω–∞–≥—Ä–∞–¥—É
                    await data.add_ref_node(int(referent_id), message.from_user.id, message.from_user.username)
                    await message.answer("You have successfully registered as a referral!")
                    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç
                    await message.answer("Airdrop DescoinüéÅFor each friend you will receive 50,000 descoin tokens!", reply_markup=await start_keyboard())
                    # –û–ø–æ–≤–µ—â–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–∞ –æ –Ω–æ–≤–æ–º —Ä–µ—Ñ–µ—Ä–∞–ª–µ
                    try:
                        await bot.send_message(chat_id=referent_id, text=f"A new user has registered using your referral link!\n@{message.from_user.username}")
                    except:
                        pass # –ï—Å–ª–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞, –æ—Ç–ª–∞–≤–ª–∏–≤–∞–µ–º –æ—à–∏–±–∫—É
            else: # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª –ø–æ —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–µ
                await message.answer("You can't use your referral link!")
        else: # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª –Ω–µ –ø–æ —Ä–µ—Ñ —Å—Å—ã–ª–∫–µ
            await message.answer("Airdrop DescoinüéÅFor each friend you will receive 50,000 descoin tokens!", reply_markup=await start_keyboard())
